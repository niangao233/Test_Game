name: Sync Markdown Issues

on:
  push:
    branches: 
      - "**"   # 改为明确的 main 分支
    paths:
      - 'docs/issues/**/*.md'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read  # 添加这个权限

    steps:
    - name: Checkout 代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'  # 添加缓存加速
        cache-dependency-path: 'docs/package.json'  # 指定缓存依赖路径

    - name: 安装依赖
      working-directory: ./docs  # 使用 working-directory 更清晰
      run: |
        npm ci --only=production  # 使用 ci 而不是 install,更可靠

    - name: 同步 Issue
      working-directory: ./docs
      env:
        # 关键：环境变量名必须是 GITHUB_TOKEN
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: node sync-issue-from-md.js